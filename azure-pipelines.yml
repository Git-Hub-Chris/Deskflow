trigger:

- master

jobs: 
- job: Windows
  strategy:
    matrix:
      vs2019:
        image: windows-2019

  pool: 
    vmImage: $[ variables['image'] ]

  variables:
    QT_VERSION: '5.9.9'
    QLI_VERSION: '2019.05.26.1'
    QLI_OUT_DIR: '.\deps\Qt'
    QLI_BASE_URL: 'http://mirrors.ocf.berkeley.edu/qt/online/qtsdkrepository/'
    QT_PATH: '$(Build.Repository.LocalPath)\$(QLI_OUT_DIR)\$(QT_VERSION)\msvc2017_64'
    BONJOUR_SDK_DIR: 'C:\Program Files\Bonjour SDK'

  steps:
#As the official installer is rather 'slow' use an unofficial installer QLI
  - task: PowerShell@2
    inputs:
      targetType: 'inline'
      script: |
        New-Item -Force -ItemType Directory -Path ".\deps\"
        $client = new-object System.Net.WebClient
        $client.DownloadFile("https://github.com/nelsonjchen/qli-installer/archive/v$(QLI_VERSION).zip","deps\qli.zip")
    displayName: 'Downloading QLI'
  - task: ExtractFiles@1
    inputs:
      archiveFilePatterns: './deps/*.zip'
      destinationFolder: './deps/'
      cleanDestinationFolder: false
    displayName: 'Extracting QLI'

  - task: PowerShell@2
    inputs:
      targetType: 'inline'
      script: 'pip install -r .\deps\qli-installer-$(QLI_VERSION)\requirements.txt'
    displayName: 'Install QLI requirements'
  - task: PythonScript@0
    inputs:
      scriptSource: 'filePath'
      scriptPath: '.\deps\qli-installer-$(QLI_VERSION)\qli-installer.py'
      arguments: '$(QT_VERSION) windows desktop win64_msvc2017_64'

  - task: PowerShell@2
    inputs:
      targetType: 'inline'
      script: |
        New-Item -Force -ItemType Directory -Path ".\deps\"
        $client = new-object System.Net.WebClient
        $client.DownloadFile("https://binaries.symless.com/bonjour/bonjoursdksetup.exe","deps\bonjoursdksetup.exe")
    displayName: 'Downloading Bonjour SKD'

  - task: PowerShell@2
    inputs:
      targetType: 'inline'
      script: |
        'deps\bonjoursdksetup.exe /quiet'
    displayName: 'Installing bonjour SDK'

  - task: PowerShell@2
    inputs:
      targetType: 'inline'
      script: |
        echo $(QT_PATH)
        Tree /F

  - task: PowerShell@2
    inputs:
      targetType: 'inline'
      script: |
        Get-ChildItem -Path C:\ -Recurse -Directory -Force -ErrorAction SilentlyContinue | Select-Object FullName
        Get-ChildItem -Path D:\ -Recurse -Directory -Force -ErrorAction SilentlyContinue | Select-Object FullName

  - script: |
      mkdir build
      cd build
      cmake -G "Visual Studio 16 2019" -A x64 -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH=$(QT_PATH) -DBONJOUR_SDK_HOME=$(BONJOUR_SDK_DIR) ..
      msbuild synergy-core.sln /p:Platform="x64" /p:Configuration=Release /m
    displayName: 'Build x64'
